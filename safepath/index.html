<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ernakulam Safety Navigator</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>

<style>
body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; }
#map { position:absolute; top:0; bottom:0; width:100%; height:100vh; }

#nav-panel {
position:absolute;
top:10px;
left:10px;
z-index:10;
background:white;
padding:15px;
border-radius:8px;
width:300px;
box-shadow:0 2px 10px rgba(0,0,0,0.3);
}

input,select {
width:92%;
padding:10px;
margin-bottom:10px;
border:1px solid #ccc;
border-radius:4px;
}

.route-btn {
background:#4285F4;
color:white;
border:none;
padding:12px;
width:100%;
border-radius:4px;
font-weight:bold;
cursor:pointer;
}

.submit-btn {
background:#ff4444;
color:white;
border:none;
padding:8px;
border-radius:4px;
cursor:pointer;
width:100%;
margin-top:5px;
}

</style>
</head>

<body>
    <script>

</script>


    <button id="sos-btn" style="
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:#ff4444;
  color:white;
  border:none;
  padding:12px 16px;
  border-radius:50%;
  font-weight:bold;
  font-size:16px;
  cursor:pointer;
  display:none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.4);
">SOS</button>

<div id="nav-panel">

<h3>Safety Navigator</h3>


<input id="start-loc" placeholder="Detecting GPS..." disabled>

<input id="end-loc" placeholder="Type place or click map">

<button class="route-btn" onclick="getRoute()">Start Navigation</button>

<div id="crowd-panel" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">

<h4>Report Safety</h4>

<label>Lighting</label>
<select id="lighting">
<option value="dark">ğŸŒ‘ Dark</option>
<option value="moderate">ğŸŒ¤ Moderate</option>
<option value="bright">ğŸ’¡ Bright</option>
</select>

<label>Crowd Level</label>
<select id="crowd">
<option value="empty">ğŸš¶ Empty</option>
<option value="few">ğŸš¶ğŸš¶ Few people</option>
<option value="busy">ğŸš¶ğŸš¶ğŸš¶ Busy</option>
</select>

<label>Safety Feeling</label>
<select id="safety">
<option value="unsafe">âš  Unsafe</option>
<option value="neutral">ğŸ˜ Neutral</option>
<option value="safe">âœ… Safe</option>
</select>

<label>CCTV Present?</label>
<select id="cctv">
<option value="yes">ğŸ“¹ Yes</option>
<option value="no">âŒ No</option>
<option value="unknown">â“ Unknown</option>
</select>

<label>Danger Flags</label>

<div>
<input type="checkbox" value="drunk_people"> Drunk people<br>
<input type="checkbox" value="stray_dogs"> Stray dogs<br>
<input type="checkbox" value="construction"> Construction<br>

</div>
<button onclick="submitCrowdReport()" class="route-btn" style="margin-top:10px;">
Submit Safety Report
</button>
<div id="route-summary" style="
display:none;
margin-top:15px;
border-top:1px solid #eee;
padding-top:10px;
background:#f8f9fa;
padding:10px;
border-radius:6px;
">

<h4>Route Safety Summary</h4>


<div id="summary-content">
Loading safety data...
</div>

</div>



</div>


</div>

<div id="map"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// load saved mode
if(localStorage.getItem("darkMode") === "enabled"){
document.body.classList.add("dark");
}
// ================= FIREBASE INIT =================
const firebaseConfig = {
  apiKey: "AIzaSyAinwvKoSUQS9d7O23oC1FA6m3uLL1ryZE",
  authDomain: "maps-9f8e9.firebaseapp.com",
  projectId: "maps-9f8e9",
  storageBucket: "maps-9f8e9.firebasestorage.app",
  messagingSenderId: "152379968772",
  appId: "1:152379968772:web:25b219c0f80d878a459451",
  measurementId: "G-DZMTCPK3XC"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();

// ================= MAP INIT =================

const map = new maplibregl.Map({
container:'map',
style:'https://tiles.openfreemap.org/styles/liberty',
center:[76.2999,9.9816],
zoom:13,
pitch:45
});

// ================= VARIABLES =================

let userLocation = null;
let destinationMarker = null;
let navMarker = null;
let navigationActive = false;


// ================= GPS =================

const geoControl = new maplibregl.GeolocateControl({
positionOptions:{ enableHighAccuracy:true },
trackUserLocation:true,
showUserHeading:true,
showAccuracyCircle:true
});

map.addControl(geoControl);

map.on('load',()=>{
geoControl.trigger();
});


geoControl.on('geolocate',(e)=>{

userLocation = [e.coords.longitude, e.coords.latitude];

document.getElementById('start-loc').value =
e.coords.latitude.toFixed(5)+", "+e.coords.longitude.toFixed(5);


// MOVE marker only when navigation active
if(navigationActive && navMarker){

navMarker.setLngLat(userLocation);

map.easeTo({
center:userLocation,
zoom:17,
pitch:60,
duration:500
});

}

});


// ================= CLICK DESTINATION =================

map.on('click',(e)=>{

setDestination(e.lngLat.lng, e.lngLat.lat);

});


// ================= SEARCH DESTINATION =================

document.getElementById("end-loc")
.addEventListener("keypress", async function(e){

if(e.key !== "Enter") return;

const query = this.value;

if(query.length < 3) return;

try{

const url =
`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;

const res = await fetch(url);

const data = await res.json();

if(data.length === 0){
alert("Place not found");
return;
}

const place = data[0];

const lng = parseFloat(place.lon);
const lat = parseFloat(place.lat);

setDestination(lng, lat, place.display_name);

map.flyTo({
center:[lng,lat],
zoom:16
});

}
catch{

alert("Search failed");

}

});


// ================= SET DESTINATION =================

function setDestination(lng, lat, name=null){

if(destinationMarker)
destinationMarker.remove();

destinationMarker = new maplibregl.Marker({
color:"#4285F4"
})
.setLngLat([lng,lat])
.addTo(map);

document.getElementById("end-loc").value =
name ? name : lat.toFixed(5)+", "+lng.toFixed(5);


// SHOW ROUTE IMMEDIATELY (LIKE GOOGLE MAPS)
if(userLocation){

previewRoute(lng, lat);

}

}

// ================= ROUTE =================

async function getRoute(){

if(!userLocation){
alert("Waiting for GPS");
return;
}

if(!destinationMarker){
alert("Select destination");
return;
}

const dest = destinationMarker.getLngLat();

const url =
`https://router.project-osrm.org/route/v1/driving/`+
`${userLocation[0]},${userLocation[1]};${dest.lng},${dest.lat}`+
`?overview=full&geometries=geojson`;

try{

const res = await fetch(url);

const data = await res.json();

if(!data.routes || data.routes.length===0){
alert("No route found");
return;
}

const coords = data.routes[0].geometry.coordinates;

drawRoute(coords);

startNavigation();

}
catch{

alert("Routing failed");

}

}

async function previewRoute(destLng, destLat){

if(!userLocation) return;

const url =
`https://router.project-osrm.org/route/v1/driving/`+
`${userLocation[0]},${userLocation[1]};${destLng},${destLat}`+
`?overview=full&geometries=geojson`;

try{

const res = await fetch(url);

const data = await res.json();

if(!data.routes || data.routes.length===0) return;

const coords = data.routes[0].geometry.coordinates;

drawRoute(coords);

}
catch{}

}

// ================= DRAW ROUTE =================

function drawRoute(coords){

if(map.getSource("route")){

map.removeLayer("route");

map.removeSource("route");

}

map.addSource("route",{
type:"geojson",
data:{
type:"Feature",
geometry:{
type:"LineString",
coordinates:coords
}
}
});

map.addLayer({

id:"route",

type:"line",

source:"route",

paint:{
"line-color":"#4285F4",
"line-width":6
}

});

}


// ================= START NAVIGATION =================

function startNavigation(){

navigationActive = true;

if(navMarker)
navMarker.remove();

navMarker = new maplibregl.Marker({
color:"#ff0000"
})
.setLngLat(userLocation)
.addTo(map);

// show crowd reporting panel
document.getElementById("crowd-panel").style.display = "block";

// show route summary panel
document.getElementById("route-summary").style.display = "block";

// load safety data
loadRouteSafetySummary();
document.getElementById("sos-btn").style.display = "block";

}

// ================= ROUTE SAFETY SUMMARY =================
async function loadRouteSafetySummary(){

try{

// get reports from Firebase
const snapshot = await db.collection("reports").get();

if(snapshot.empty){

document.getElementById("summary-content").innerHTML =
"No safety reports available";

return;

}
function endNavigation(){
  navigationActive = false;
  if(navMarker) navMarker.remove();
  document.getElementById("crowd-panel").style.display = "none";
  document.getElementById("route-summary").style.display = "none";
  document.getElementById("sos-btn").style.display = "none";
}

let totalReports = 0;
let totalRating = 0;

snapshot.forEach(doc=>{

const data = doc.data();

if(data.rating){
totalRating += Number(data.rating);
totalReports++;
}

});

// calculate average
let avgSafety = (totalRating / totalReports).toFixed(1);

// display result
let html = `
Reports analyzed: ${totalReports}<br>
Safety score: ${avgSafety} / 10<br><br>
`;

if(avgSafety >= 7)
html += "Status: âœ… Safe route<br>";
else if(avgSafety >= 4)
html += "Status: âš  Moderate caution<br>";
else
html += "Status: âŒ Unsafe route<br>";

document.getElementById("summary-content").innerHTML = html;

}
catch(e){

console.error(e);

document.getElementById("summary-content").innerHTML =
"Error loading safety data";

}

}

async function submitCrowdReport()
{
if(!userLocation)
{
alert("Location unavailable");
return;
}

const lighting =
document.getElementById("lighting").value;

const crowd =
document.getElementById("crowd").value;

const safety =
document.getElementById("safety").value;

const cctv =
document.getElementById("cctv").value;


// collect danger flags
const flags = [];

document.querySelectorAll('#crowd-panel input[type="checkbox"]:checked')
.forEach(cb => flags.push(cb.value));


const report =
{
lat: userLocation[1],
lng: userLocation[0],

lighting: lighting,
crowd: crowd,
safety: safety,
cctv: cctv,

danger_flags: flags,

time: new Date()
};

console.log(report);

// later send to Firebase
alert("Safety report submitted");
}
function toggleDarkMode(){

document.body.classList.toggle("dark");

// save preference
if(document.body.classList.contains("dark")){
localStorage.setItem("darkMode", "enabled");
}else{
localStorage.setItem("darkMode", "disabled");
}

}

document.getElementById("sos-btn").addEventListener("click", async () => {
  if(!userLocation){
    alert("GPS location not available!");
    return;
  }

  // Prepare emergency data
  const sosData = {
    lat: userLocation[1],
    lng: userLocation[0],
    time: new Date(),
    message: "ğŸš¨ Emergency! Need help at this location."
  };

  // Example: Send to Firebase 'sos_alerts' collection
  try{
    await db.collection("sos_alerts").add(sosData);
    alert("SOS alert sent to your emergency contacts!");
  }
  catch(e){
    console.error(e);
    alert("Failed to send SOS alert.");
  }
});
</script>




</body>
</html>